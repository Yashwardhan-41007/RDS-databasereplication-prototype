name: RDS Replication

# SECURITY: Passwords are automatically masked in logs (appear as ***)
# Uses SSH tunnel through bastion host to access private RDS instances
# Requires: BASTION_SSH_KEY, BASTION_HOST, BASTION_USER secrets in GitHub

on:
  # Manual trigger - Click "Run workflow" button in GitHub Actions tab
  workflow_dispatch:
    inputs:
      database_name:
        description: 'Database name to replicate'
        required: true
        default: 'dummy'
      src_host:
        description: 'Source RDS Host'
        required: true
      src_user:
        description: 'Source RDS Username'
        required: true
      src_pass:
        description: 'Source RDS Password'
        required: true
      tgt_host:
        description: 'Target RDS Host'
        required: true
      tgt_user:
        description: 'Target RDS Username'
        required: true
      tgt_pass:
        description: 'Target RDS Password'
        required: true

jobs:
  replicate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Mask Sensitive Data
      run: |
        echo "::add-mask::${{ inputs.src_pass }}"
        echo "::add-mask::${{ inputs.tgt_pass }}"
        echo "üîí Passwords masked in logs"
    
    - name: Setup SSH Tunnel
      env:
        SSH_KEY: ${{ secrets.BASTION_SSH_KEY }}
        BASTION_HOST: ${{ secrets.BASTION_HOST }}
        BASTION_USER: ${{ secrets.BASTION_USER }}
      run: |
        set -e
        
        echo "üîß Setting up SSH tunnel..."
        
        # Create SSH directory
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # Save SSH key
        echo "$SSH_KEY" > ~/.ssh/bastion_key
        chmod 600 ~/.ssh/bastion_key
        
        # Verify key format
        if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/bastion_key; then
          echo "‚ùå SSH key format invalid - must contain BEGIN PRIVATE KEY header"
          exit 1
        fi
        
        echo "‚úÖ SSH key saved"
        
        # Add bastion to known hosts (suppress warnings)
        ssh-keyscan -H $BASTION_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
        
        echo "‚úÖ Added bastion to known hosts"
        
        # Test SSH connection first
        echo "Testing SSH connection to bastion..."
        if ! ssh -i ~/.ssh/bastion_key -o ConnectTimeout=10 -o StrictHostKeyChecking=no $BASTION_USER@$BASTION_HOST "echo 'SSH connection successful'" 2>&1; then
          echo "‚ùå SSH connection to bastion failed"
          echo "Troubleshooting tips:"
          echo "1. Verify BASTION_HOST is correct"
          echo "2. Verify BASTION_USER is correct (usually 'ubuntu' or 'ec2-user')"
          echo "3. Verify SSH key matches the one used for bastion"
          echo "4. Check bastion security group allows SSH (port 22) from GitHub Actions IPs"
          exit 1
        fi
        
        echo "‚úÖ SSH connection to bastion successful"
        
        # Start SSH tunnel in background for source RDS
        echo "Creating tunnel for source RDS: ${{ inputs.src_host }}"
        ssh -i ~/.ssh/bastion_key -o StrictHostKeyChecking=no -f -N -L 3307:${{ inputs.src_host }}:3306 $BASTION_USER@$BASTION_HOST
        
        # Start SSH tunnel in background for target RDS
        echo "Creating tunnel for target RDS: ${{ inputs.tgt_host }}"
        ssh -i ~/.ssh/bastion_key -o StrictHostKeyChecking=no -f -N -L 3308:${{ inputs.tgt_host }}:3306 $BASTION_USER@$BASTION_HOST
        
        # Verify tunnels are running
        sleep 2
        if ! netstat -an | grep -q "127.0.0.1:3307"; then
          echo "‚ùå Source tunnel (port 3307) failed to establish"
          exit 1
        fi
        
        if ! netstat -an | grep -q "127.0.0.1:3308"; then
          echo "‚ùå Target tunnel (port 3308) failed to establish"
          exit 1
        fi
        
        echo "‚úÖ SSH tunnels established successfully"
        echo "   - Source RDS: localhost:3307 ‚Üí ${{ inputs.src_host }}:3306"
        echo "   - Target RDS: localhost:3308 ‚Üí ${{ inputs.tgt_host }}:3306"
    
    - name: Install MySQL Client
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y mysql-client
        
    - name: Test Connections
      env:
        SRC_PASS: ${{ inputs.src_pass }}
        TGT_PASS: ${{ inputs.tgt_pass }}
      run: |
        echo "Testing source RDS connection (through SSH tunnel)..."
        mysql -h 127.0.0.1 -P 3307 -u ${{ inputs.src_user }} -p"${SRC_PASS}" -e "SELECT 1" > /dev/null 2>&1
        echo "‚úÖ Source connection OK"
        
        echo "Testing target RDS connection (through SSH tunnel)..."
        mysql -h 127.0.0.1 -P 3308 -u ${{ inputs.tgt_user }} -p"${TGT_PASS}" -e "SELECT 1" > /dev/null 2>&1
        echo "‚úÖ Target connection OK"
        
    - name: Replicate Database
      env:
        SRC_PASS: ${{ inputs.src_pass }}
        TGT_PASS: ${{ inputs.tgt_pass }}
      run: |
        echo "üîÑ Starting replication of database: ${{ github.event.inputs.database_name }}"
        echo "Source: ${{ inputs.src_host }}"
        echo "Target: ${{ inputs.tgt_host }}"
        
        mysqldump -h 127.0.0.1 -P 3307 \
                  -u ${{ inputs.src_user }} \
                  -p"${SRC_PASS}" \
                  --single-transaction \
                  --quick \
                  --routines \
                  --triggers \
                  --events \
                  --set-gtid-purged=OFF \
                  --databases ${{ github.event.inputs.database_name }} \
        2>/dev/null | mysql -h 127.0.0.1 -P 3308 \
                -u ${{ inputs.tgt_user }} \
                -p"${TGT_PASS}" \
        2>/dev/null
        
        echo "‚úÖ Replication completed successfully!"
        
    - name: Verify Replication
      env:
        SRC_PASS: ${{ inputs.src_pass }}
        TGT_PASS: ${{ inputs.tgt_pass }}
      run: |
        echo "üîç Verifying replication..."
        
        SRC_TABLES=$(mysql -h 127.0.0.1 -P 3307 \
                           -u ${{ inputs.src_user }} \
                           -p"${SRC_PASS}" \
                           -N -e "SELECT COUNT(*) FROM information_schema.TABLES WHERE TABLE_SCHEMA='${{ github.event.inputs.database_name }}'" \
                           2>/dev/null)
        
        TGT_TABLES=$(mysql -h 127.0.0.1 -P 3308 \
                           -u ${{ inputs.tgt_user }} \
                           -p"${TGT_PASS}" \
                           -N -e "SELECT COUNT(*) FROM information_schema.TABLES WHERE TABLE_SCHEMA='${{ github.event.inputs.database_name }}'" \
                           2>/dev/null)
        
        echo "Source tables: $SRC_TABLES"
        echo "Target tables: $TGT_TABLES"
        
        if [ "$SRC_TABLES" -eq "$TGT_TABLES" ]; then
          echo "‚úÖ Verification passed - Table counts match!"
        else
          echo "‚ö†Ô∏è  Warning: Table count mismatch"
          exit 1
        fi
