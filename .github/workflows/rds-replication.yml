name: RDS Replication

# SECURITY: Passwords are automatically masked in logs (appear as ***)
# Uses AWS SSM Port Forwarding to create local tunnels to private RDS instances
# Requires: AWS_ROLE_ARN (IAM role), SSM_INSTANCE_ID secrets in GitHub

# Required for OIDC authentication with AWS
permissions:
  id-token: write
  contents: read

on:
  # Manual trigger - Click "Run workflow" button in GitHub Actions tab
  workflow_dispatch:
    inputs:
      database_name:
        description: 'Database name to replicate'
        required: true
        default: 'dummy'
      src_host:
        description: 'Source RDS Host'
        required: true
      src_user:
        description: 'Source RDS Username'
        required: true
      src_pass:
        description: 'Source RDS Password'
        required: true
      tgt_host:
        description: 'Target RDS Host'
        required: true
      tgt_user:
        description: 'Target RDS Username'
        required: true
      tgt_pass:
        description: 'Target RDS Password'
        required: true

jobs:
  replicate:
    runs-on: ubuntu-latest
    
    env:
      AWS_REGION: ap-south-1
      SRC_LOCAL_PORT: "13306"
      TGT_LOCAL_PORT: "13307"
    
    steps:
    - name: Mask Sensitive Data
      run: |
        echo "::add-mask::${{ inputs.src_pass }}"
        echo "::add-mask::${{ inputs.tgt_pass }}"
        echo "üîí Passwords masked in logs"
    
    - name: Configure AWS Credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}
        role-session-name: GitHubActions-RDS-Replication
    
    - name: Install Session Manager Plugin & MySQL Client
      run: |
        echo "üì¶ Installing AWS Session Manager plugin..."
        curl -sLo /tmp/ssm.deb https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb
        sudo apt-get update -qq
        sudo dpkg -i /tmp/ssm.deb || sudo apt-get -f install -y
        
        echo "üì¶ Installing MySQL client..."
        sudo apt-get install -y mysql-client
        
        echo "‚úÖ Installation complete"
        
    - name: Start SSM Port Forward to Source RDS
      run: |
        echo "üîå Starting port forward to source RDS..."
        nohup aws ssm start-session \
          --region "$AWS_REGION" \
          --target "${{ secrets.SSM_INSTANCE_ID }}" \
          --document-name AWS-StartPortForwardingSessionToRemoteHost \
          --parameters "{\"host\":[\"${{ inputs.src_host }}\"],\"portNumber\":[\"3306\"],\"localPortNumber\":[\"$SRC_LOCAL_PORT\"]}" \
          > ssm-src-forward.log 2>&1 & echo $! > ssm_src.pid
        
        echo "‚è≥ Waiting for tunnel to establish..."
        sleep 5
        echo "‚úÖ Source tunnel started on localhost:$SRC_LOCAL_PORT"
    
    - name: Start SSM Port Forward to Target RDS
      run: |
        echo "üîå Starting port forward to target RDS..."
        nohup aws ssm start-session \
          --region "$AWS_REGION" \
          --target "${{ secrets.SSM_INSTANCE_ID }}" \
          --document-name AWS-StartPortForwardingSessionToRemoteHost \
          --parameters "{\"host\":[\"${{ inputs.tgt_host }}\"],\"portNumber\":[\"3306\"],\"localPortNumber\":[\"$TGT_LOCAL_PORT\"]}" \
          > ssm-tgt-forward.log 2>&1 & echo $! > ssm_tgt.pid
        
        echo "‚è≥ Waiting for tunnel to establish..."
        sleep 5
        echo "‚úÖ Target tunnel started on localhost:$TGT_LOCAL_PORT"
    
    - name: Test Connections
      env:
        SRC_PASS: ${{ inputs.src_pass }}
        TGT_PASS: ${{ inputs.tgt_pass }}
      run: |
        echo "üîç Testing source RDS connection..."
        mysqladmin -h127.0.0.1 -P${SRC_LOCAL_PORT} -u"${{ inputs.src_user }}" -p"${SRC_PASS}" ping
        echo "‚úÖ Source RDS connection successful"
        
        echo "üîç Testing target RDS connection..."
        mysqladmin -h127.0.0.1 -P${TGT_LOCAL_PORT} -u"${{ inputs.tgt_user }}" -p"${TGT_PASS}" ping
        echo "‚úÖ Target RDS connection successful"
        
    - name: Replicate Database
      env:
        SRC_PASS: ${{ inputs.src_pass }}
        TGT_PASS: ${{ inputs.tgt_pass }}
      run: |
        set -euo pipefail
        echo "üîÑ Starting replication of database: ${{ github.event.inputs.database_name }}"
        echo "Source: ${{ inputs.src_host }} (via localhost:$SRC_LOCAL_PORT)"
        echo "Target: ${{ inputs.tgt_host }} (via localhost:$TGT_LOCAL_PORT)"
        echo ""
        
        # Perform replication using local tunnels
        mysqldump -h127.0.0.1 -P${SRC_LOCAL_PORT} \
          -u"${{ inputs.src_user }}" -p"${SRC_PASS}" \
          --single-transaction \
          --quick \
          --routines \
          --triggers \
          --events \
          --set-gtid-purged=OFF \
          --databases ${{ github.event.inputs.database_name }} \
          --connect-timeout=30 \
          --max_allowed_packet=1073741824 \
        | mysql -h127.0.0.1 -P${TGT_LOCAL_PORT} \
          -u"${{ inputs.tgt_user }}" -p"${TGT_PASS}" \
          --connect-timeout=30 \
          --max_allowed_packet=1073741824
        
        echo "‚úÖ Replication completed successfully!"
        
    - name: Verify Replication
      env:
        SRC_PASS: ${{ inputs.src_pass }}
        TGT_PASS: ${{ inputs.tgt_pass }}
      run: |
        echo "üîç Verifying replication..."
        
        # Get source table count
        SRC_TABLES=$(mysql -h127.0.0.1 -P${SRC_LOCAL_PORT} \
          -u"${{ inputs.src_user }}" -p"${SRC_PASS}" \
          -N -e "SELECT COUNT(*) FROM information_schema.TABLES WHERE TABLE_SCHEMA='${{ github.event.inputs.database_name }}'")
        
        # Get target table count
        TGT_TABLES=$(mysql -h127.0.0.1 -P${TGT_LOCAL_PORT} \
          -u"${{ inputs.tgt_user }}" -p"${TGT_PASS}" \
          -N -e "SELECT COUNT(*) FROM information_schema.TABLES WHERE TABLE_SCHEMA='${{ github.event.inputs.database_name }}'")
        
        echo "Source tables: $SRC_TABLES"
        echo "Target tables: $TGT_TABLES"
        
        if [ "$SRC_TABLES" = "$TGT_TABLES" ] && [ ! -z "$SRC_TABLES" ]; then
          echo "‚úÖ Verification passed - Table counts match!"
        else
          echo "‚ö†Ô∏è  Warning: Table count mismatch or verification failed"
          exit 1
        fi
    
    - name: Cleanup Tunnels
      if: always()
      run: |
        echo "üßπ Cleaning up SSM port forwarding sessions..."
        if [ -f ssm_src.pid ]; then kill $(cat ssm_src.pid) || true; fi
        if [ -f ssm_tgt.pid ]; then kill $(cat ssm_tgt.pid) || true; fi
        pkill -f AWS-StartPortForwardingSessionToRemoteHost || true
        echo "‚úÖ Cleanup complete"
